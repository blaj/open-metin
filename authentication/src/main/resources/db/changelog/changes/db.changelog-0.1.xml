<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE databaseChangeLog [
  <!ENTITY auditColumns '
    <column name="created_by" type="uuid"/>

    <column name="created_at" type="datetime" defaultValueComputed="CURRENT_TIMESTAMP">
      <constraints nullable="false"/>
    </column>

    <column name="updated_by" type="uuid"/>

    <column name="updated_at" type="datetime"/>

    <column name="deleted_by" type="uuid"/>

    <column name="deleted_at" type="datetime"/>

    <column name="deleted" type="boolean" defaultValue="false">
      <constraints nullable="false"/>
    </column>
  '>
  ]>

<databaseChangeLog
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.31.xsd">
  <changeSet author="AM" id="0.1.0.init-test">
    <comment>Test command to check if liquibase configuration works</comment>
    <createTable tableName="liquibase_test">
      <column name="column1" type="TEXT">
        <constraints nullable="true" primaryKey="false" unique="false"/>
      </column>
    </createTable>

    <rollback>
      <dropTable tableName="liquibase_test"/>
    </rollback>

    <sql>
      GRANT INSERT, SELECT, UPDATE ON liquibase_test TO openmetin_authentication_user;
    </sql>
  </changeSet>

  <changeSet author="AM" id="0.1.1.init-test-cleanup">
    <comment>Cleanup test table</comment>

    <dropTable tableName="liquibase_test"/>
  </changeSet>

  <changeSet author="AM" id="0.2.0.create-account-schema">
    <comment>Create account schema</comment>

    <rollback>
      DROP SCHEMA IF EXISTS account;
    </rollback>

    <sql>
      CREATE SCHEMA account;

      GRANT USAGE ON SCHEMA account TO openmetin_authentication_user;
    </sql>
  </changeSet>

  <changeSet author="AM" id="0.2.1.create-account-table">
    <comment>Create account table</comment>

    <createTable schemaName="account" tableName="account">
      <column autoIncrement="true" name="id" type="bigint">
        <constraints primaryKey="true"/>
      </column>

      <column name="username" type="varchar(30)">
        <constraints nullable="false"/>
      </column>

      <column name="password" type="varchar(100)">
        <constraints nullable="false"/>
      </column>

      <column name="email" type="varchar(200)">
        <constraints nullable="false"/>
      </column>

      <column name="last_login_at" type="timestamp without time zone"/>

      <column name="delete_code" type="char(7)">
        <constraints nullable="false"/>
      </column>

      &auditColumns;
    </createTable>

    <rollback>
      DROP TABLE IF EXISTS account.account;
    </rollback>
  </changeSet>

  <changeSet author="AM" id="0.2.2.add-unique-constraints-account">
    <comment>Add unique constraints for username and email when not deleted</comment>

    <rollback>
      DROP INDEX IF EXISTS account.idx_account_username_unique;
      DROP INDEX IF EXISTS account.idx_account_email_unique;
    </rollback>

    <sql>
      CREATE UNIQUE INDEX idx_account_username_unique
      ON account.account(username)
      WHERE deleted = false;

      CREATE UNIQUE INDEX idx_account_email_unique
      ON account.account(email)
      WHERE deleted = false;
    </sql>
  </changeSet>

  <changeSet author="AM" id="0.2.3.grant-permissions-to-account-table">
    <rollback>
      REVOKE USAGE, SELECT ON ALL SEQUENCES IN SCHEMA account FROM openmetin_authentication_user;
      REVOKE INSERT, SELECT, UPDATE ON account.account FROM openmetin_authentication_user;
      REVOKE USAGE ON SCHEMA account FROM openmetin_authentication_user;
    </rollback>

    <sql>
      GRANT USAGE ON SCHEMA account TO openmetin_authentication_user;
      GRANT INSERT, SELECT, UPDATE ON account.account TO openmetin_authentication_user;
      GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA account TO openmetin_authentication_user;
    </sql>
  </changeSet>

  <changeSet author="AM" id="0.2.4.insert-test-account">
    <rollback>
      DELETE FROM account.account WHERE username = 'admin';
    </rollback>

    <sql>
      INSERT INTO account.account(username, password, email, delete_code)
      VALUES('admin', '$2a$10$m76hCjZ9boMxO9KDw88M6O0RaBZW8wBepYkbah4BQ3yX5b6cSRLg.',
      'admin@admin.com', '1234567')
    </sql>
  </changeSet>
</databaseChangeLog>